# ðŸš‚ Railway Deployment Update Guide

**Update your existing Railway deployment with:**
- Google Gemini LLM integration (free tier alternative to OpenAI)
- Financial Documents RAG system (SEC filings analysis)

---

## ðŸ“‹ What's New

### 1. Google Gemini Integration
- **Free tier**: 60 requests/min (vs OpenAI's 3-5 req/min on free tier)
- **No credit card required**: Works immediately
- **Fast**: 2-3 second response times
- **Model**: gemini-2.5-flash

### 2. Financial Documents RAG
- **SEC filings**: 10-K, 10-Q, 8-K documents
- **Companies**: AAPL, MSFT, GOOGL, AMZN, TSLA, META, NVDA
- **Separate index**: financial-docs-chunks
- **Advanced filtering**: By ticker symbol and filing type

---

## ðŸš€ Quick Update Steps

### Step 1: Add Gemini Environment Variables to Railway

Go to your Railway project â†’ API service â†’ Variables tab

**Add these new variables:**

```plaintext
# Google Gemini Configuration
GEMINI_API_KEY = YOUR_GEMINI_API_KEY_HERE
GEMINI_MODEL = gemini-2.5-flash
GEMINI_MAX_TOKENS = 2000
```

**Update LLM provider to use Gemini (recommended):**

```plaintext
LLM_PROVIDER = gemini
```

Or keep as `openai` if you prefer OpenAI.

#### How to Get Gemini API Key (2 minutes):

1. Go to: https://aistudio.google.com/app/apikey
2. Click "Get API Key" or "Create API Key"
3. Select your Google account
4. Click "Create API key in new project"
5. Copy the key (starts with `AIza...`)

---

### Step 2: Add Financial Documents Index Variables

**Add these to Railway Variables:**

```plaintext
# Financial Documents OpenSearch Index
OPENSEARCH__FINANCIAL_INDEX_NAME = financial-docs-chunks

# Financial Documents Configuration
FINANCIAL_DOCS__COMPANIES = AAPL,MSFT,GOOGL,AMZN,TSLA,META,NVDA
FINANCIAL_DOCS__FILING_TYPES = 10-K,10-Q,8-K
FINANCIAL_DOCS__MAX_FILES_PER_COMPANY = 3
```

---

### Step 3: Push Latest Code to GitHub

Railway auto-deploys when you push to GitHub.

```bash
# Make sure all changes are committed
git status

# If there are uncommitted changes, commit them
git add .
git commit -m "Add Gemini integration and financial documents RAG"

# Push to trigger Railway deployment
git push origin main
```

Railway will automatically:
- Detect the push
- Build the new Docker image
- Deploy with updated code
- Restart the service

---

### Step 4: Verify Deployment

Wait 3-5 minutes for Railway to build and deploy.

#### Check Health Endpoint:

```bash
# Replace with your Railway URL
RAILWAY_URL="https://your-app.up.railway.app"

curl $RAILWAY_URL/api/v1/health
```

**Expected response:**
```json
{
  "status": "healthy",
  "version": "0.1.0",
  "services": {
    "database": {
      "status": "healthy"
    },
    "opensearch": {
      "status": "healthy"
    },
    "llm": {
      "status": "healthy",
      "provider": "gemini"
    }
  }
}
```

---

## ðŸ§ª Testing New Features

### Test 1: Gemini LLM with arXiv Papers

```bash
RAILWAY_URL="https://your-app.up.railway.app"

curl -X POST "$RAILWAY_URL/api/v1/ask" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What papers discuss transformer architectures?",
    "top_k": 3,
    "document_type": "arxiv"
  }'
```

**Expected**: Response generated by Gemini with arXiv paper citations

---

### Test 2: Financial Documents RAG

First, you need to ingest financial documents. Two options:

#### Option A: Via API (Manual Trigger)

```bash
# Fetch and index Apple 10-K filing
curl -X POST "$RAILWAY_URL/api/v1/financial/ingest" \
  -H "Content-Type: application/json" \
  -d '{
    "ticker": "AAPL",
    "filing_type": "10-K",
    "max_files": 1
  }'
```

This will:
1. Fetch Apple's latest 10-K from SEC EDGAR
2. Parse the HTML document
3. Generate embeddings
4. Index to OpenSearch

**Note**: This takes 2-5 minutes per document.

#### Option B: Bulk Ingestion

```bash
# Ingest documents for all configured companies
for ticker in AAPL MSFT GOOGL AMZN TSLA META NVDA; do
  curl -X POST "$RAILWAY_URL/api/v1/financial/ingest" \
    -H "Content-Type: application/json" \
    -d "{
      \"ticker\": \"$ticker\",
      \"filing_type\": \"10-K\",
      \"max_files\": 1
    }"

  echo "Ingested $ticker, waiting 30 seconds..."
  sleep 30
done
```

---

### Test 3: Query Financial Documents

```bash
# Ask about Apple's business segments
curl -X POST "$RAILWAY_URL/api/v1/ask" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What are Apple main business segments?",
    "top_k": 3,
    "document_type": "financial",
    "ticker": "AAPL"
  }'
```

**Expected response:**
```json
{
  "answer": "Apple Inc. operates through several main business segments including iPhone, Mac, iPad, Wearables/Home/Accessories, and Services...",
  "sources": [
    "https://www.sec.gov/cgi-bin/viewer?action=view&cik=320193&accession_number=..."
  ],
  "citations": [
    "AAPL 10-K"
  ],
  "confidence": "high",
  "model_used": "gemini-2.5-flash"
}
```

---

### Test 4: Hybrid Document Query

```bash
# Compare Microsoft's financials
curl -X POST "$RAILWAY_URL/api/v1/ask" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What are Microsoft revenue streams?",
    "top_k": 5,
    "document_type": "financial",
    "ticker": "MSFT"
  }'
```

---

## ðŸ“Š Railway Environment Variables - Complete List

Here's the full list of environment variables for your Railway deployment:

### Core Application
```plaintext
ENVIRONMENT = production
DEBUG = false
```

### Database (Auto-configured)
```plaintext
POSTGRES_DATABASE_URL = ${{Postgres.DATABASE_URL}}
```

### OpenSearch
```plaintext
OPENSEARCH_HOST = http://opensearch.railway.internal:9200
OPENSEARCH__HOST = http://opensearch.railway.internal:9200
OPENSEARCH__INDEX_NAME = arxiv-papers
OPENSEARCH__CHUNK_INDEX_SUFFIX = chunks
OPENSEARCH__FINANCIAL_INDEX_NAME = financial-docs-chunks
OPENSEARCH__VECTOR_DIMENSION = 1024
```

### LLM Configuration (Choose one provider)

#### Option 1: Google Gemini (Recommended for free tier)
```plaintext
LLM_PROVIDER = gemini
GEMINI_API_KEY = AIzaSy...your-actual-key
GEMINI_MODEL = gemini-2.5-flash
GEMINI_MAX_TOKENS = 2000
```

#### Option 2: OpenAI (If you have credits)
```plaintext
LLM_PROVIDER = openai
OPENAI_API_KEY = sk-proj-...your-actual-key
OPENAI_MODEL = gpt-4o-mini
OPENAI_MAX_TOKENS = 500
```

### Embeddings (Jina AI)
```plaintext
JINA_API_KEY = jina_...your-actual-key
EMBEDDINGS__MODEL = jina-embeddings-v3
EMBEDDINGS__TASK = retrieval.passage
EMBEDDINGS__DIMENSIONS = 1024
```

### arXiv Configuration
```plaintext
ARXIV__MAX_RESULTS = 25
ARXIV__SEARCH_CATEGORY = cs.AI
ARXIV__PDF_CACHE_DIR = ./data/arxiv_pdfs
```

### Financial Documents Configuration
```plaintext
FINANCIAL_DOCS__COMPANIES = AAPL,MSFT,GOOGL,AMZN,TSLA,META,NVDA
FINANCIAL_DOCS__FILING_TYPES = 10-K,10-Q,8-K
FINANCIAL_DOCS__MAX_FILES_PER_COMPANY = 3
```

### PDF Parser
```plaintext
PDF_PARSER__DO_OCR = false
PDF_PARSER__DO_TABLE_STRUCTURE = false
PDF_PARSER__MAX_PAGES = 50
```

### Chunking
```plaintext
CHUNKING__CHUNK_SIZE = 600
CHUNKING__CHUNK_OVERLAP = 100
```

---

## ðŸŽ¯ New API Endpoints

### Financial Documents Endpoints

#### 1. Ingest Financial Documents
```
POST /api/v1/financial/ingest
```

**Request:**
```json
{
  "ticker": "AAPL",
  "filing_type": "10-K",
  "max_files": 1
}
```

#### 2. Search Financial Documents
```
POST /api/v1/financial/search
```

**Request:**
```json
{
  "query": "revenue streams",
  "ticker": "AAPL",
  "filing_types": ["10-K"],
  "top_k": 5
}
```

#### 3. Ask Question (Financial)
```
POST /api/v1/ask
```

**Request:**
```json
{
  "query": "What are Apple's main business segments?",
  "top_k": 3,
  "document_type": "financial",
  "ticker": "AAPL"
}
```

#### 4. Stream Response (Financial)
```
POST /api/v1/ask/stream
```

Same request format as `/api/v1/ask` but returns streaming SSE response.

---

## ðŸ’° Cost Comparison

### Using OpenAI
- **API Costs**: ~$0.001-0.01 per query
- **100 queries/day**: ~$3-10/month
- **Rate limits**: 3-5 req/min on free tier

### Using Gemini (Recommended)
- **API Costs**: FREE (up to quota)
- **Rate limits**: 60 requests/min
- **Quota**: 1500 requests/day
- **No credit card needed**

### Railway Infrastructure
- **Starter plan**: $5/month (500 hours)
- **Additional usage**: ~$5-10/month
- **Total with Gemini**: ~$10-15/month

---

## ðŸ”§ Troubleshooting

### Issue: Gemini API Error "API key not valid"
**Solution:**
1. Verify API key starts with `AIza`
2. Check for spaces or quotes in Railway variable
3. Regenerate key if needed

### Issue: Financial documents not indexing
**Solution:**
1. Check OpenSearch is running: `curl $RAILWAY_URL/api/v1/health`
2. Verify financial index exists
3. Check Railway logs for errors

### Issue: "Model not found" error with Gemini
**Solution:**
1. Use `gemini-2.5-flash` (not `gemini-1.5-flash`)
2. Check GEMINI_MODEL environment variable
3. Verify API key has access to the model

### Issue: Slow financial document ingestion
**Expected behavior**: SEC filings are large (10-50 pages), takes 2-5 minutes per document
**Solution:**
- Use smaller `max_files` parameter
- Increase Railway plan for more resources
- Process documents in background

---

## ðŸ“ˆ Monitoring

### Check Railway Logs

```bash
# Install Railway CLI
npm install -g @railway/cli

# Login and link
railway login
railway link

# View logs
railway logs
```

### Health Monitoring

Set up a cron job or monitoring service to ping:
```
https://your-app.up.railway.app/api/v1/health
```

Expected: 200 OK response every 5 minutes

---

## âœ… Deployment Checklist

After updating:

- [ ] Gemini API key added to Railway variables
- [ ] LLM_PROVIDER set to "gemini"
- [ ] Financial documents variables added
- [ ] Code pushed to GitHub
- [ ] Railway auto-deployment completed (check logs)
- [ ] Health endpoint returns "healthy"
- [ ] Test arXiv query with Gemini
- [ ] Ingest at least 1 financial document
- [ ] Test financial document query
- [ ] API documentation accessible at /docs

---

## ðŸŽ‰ Success!

Your Railway deployment now has:

âœ… **Dual RAG System**
   - arXiv research papers
   - SEC financial filings

âœ… **Multi-LLM Support**
   - Google Gemini (free tier)
   - OpenAI (paid tier)

âœ… **Advanced Features**
   - Hybrid search (BM25 + vector)
   - Document type routing
   - Ticker symbol filtering
   - Streaming responses

âœ… **Production Ready**
   - Health checks
   - Error handling
   - Auto-deployment from GitHub
   - Comprehensive API docs

---

## ðŸ”— Quick Links

**API Documentation:**
```
https://your-app.up.railway.app/docs
```

**Health Check:**
```
https://your-app.up.railway.app/api/v1/health
```

**GitHub Repository:**
```
https://github.com/your-username/arxiv-paper-curator
```

---

## ðŸ“ž Support

- **Gemini API**: https://ai.google.dev/
- **Railway Docs**: https://docs.railway.app
- **SEC EDGAR**: https://www.sec.gov/edgar

---

**Questions?** Check the main [README](../README.md) or open an issue on GitHub.
